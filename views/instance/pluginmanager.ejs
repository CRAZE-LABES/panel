<% /* Dark theme, plugin cards, modrinth search & version selector, 10+ plugin support */ %>
<style>
body {
    background: #2e3440;
    color: #d8dee9;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Arial, sans-serif;
}
.plugin-container {
    background: #3b4252;
    border-radius: 10px;
    padding: 30px 20px;
    margin: 30px auto;
    max-width: 98vw;
    box-shadow: 0 4px 32px 0 rgba(0,0,0,0.2);
}
.plugin-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: flex-start;
}
.plugin-card {
    background: #434c5e;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 8px 0 rgba(0,0,0,0.08);
    color: #eceff4;
    width: 270px;
    min-height: 170px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.plugin-card h4 {
    margin: 0 0 6px 0;
    font-size: 1.08em;
    color: #88c0d0;
}
.plugin-card p {
    margin-bottom: 10px;
    font-size: 0.98em;
    color: #d8dee9;
    flex: 1;
}
input[type="text"], .search-bar {
    background: #434c5e;
    color: #eceff4;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 15px;
}
button, .btn {
    background: #5e81ac;
    color: #eceff4;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    margin-top: 4px;
    transition: background 0.2s;
    display: inline-flex;
    align-items: center;
    font-size: 0.98em;
}
button:hover, .btn:hover {
    background: #81a1c1;
}
.icon-download {
    font-size: 1.2em;
    margin-right: 7px;
}
.modrinth-btn {
    background: #a3be8c;
    color: #2e3440;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    margin-left: 14px;
    margin-bottom: 10px;
    font-weight: 500;
}
.modrinth-btn:hover {
    background: #b8eeaa;
}
.version-select {
    width: 100%;
    background: #4c566a;
    color: #eceff4;
    border: none;
    border-radius: 4px;
    padding: 6px 8px;
    margin-top: 8px;
}
@media (max-width: 900px) {
    .plugin-grid {
        flex-direction: column;
        gap: 0;
    }
    .plugin-card {
        width: 92vw;
        margin: 10px auto;
    }
    .plugin-container {
        padding: 10px 3vw;
    }
}
</style>

<div class="plugin-container">
    <form method="get" style="margin-bottom: 16px;display:flex;align-items:center;">
        <input type="text" name="q" class="search-bar" value="<%= typeof q !== 'undefined' ? q : '' %>" placeholder="Search plugins..." style="flex:1;">
        <button type="submit" class="btn" style="margin-left:10px;">Search</button>
        <button type="button" class="modrinth-btn" onclick="openModrinthSelector()">Browse Modrinth</button>
    </form>

    <div class="plugin-grid">
        <% if (plugins && plugins.length > 0) { %>
            <% plugins.forEach(function(plugin, idx){ %>
                <div class="plugin-card">
                    <h4><%= plugin.name %></h4>
                    <p>
                        <%= plugin.description ? plugin.description : 'No description.' %>
                        <% if (plugin.version) { %>
                            <br><span style="font-size:0.95em;color:#a3be8c;">v<%= plugin.version %></span>
                        <% } %>
                    </p>
                    <% if (plugin.modrinth_versions && plugin.modrinth_versions.length > 0) { %>
                        <form method="post" action="/instance/<%= instance ? instance.Id : 'INSTANCE_ID' %>/plugins/install" style="margin:0;">
                            <input type="hidden" name="pluginId" value="<%= plugin.id || plugin.name %>">
                            <label for="version-<%= idx %>" style="font-size:0.97em;margin-bottom:3px;">Version:</label>
                            <select id="version-<%= idx %>" name="version" class="version-select">
                                <% plugin.modrinth_versions.forEach(function(ver){ %>
                                    <option value="<%= ver.id %>"><%= ver.name %></option>
                                <% }) %>
                            </select>
                            <button type="submit" class="btn" style="margin-top:10px;">
                                <span class="icon-download">&#128229;</span> Install
                            </button>
                        </form>
                    <% } else { %>
                        <form method="post" action="/instance/<%= instance ? instance.Id : 'INSTANCE_ID' %>/plugins/install" style="margin:0;">
                            <input type="hidden" name="pluginId" value="<%= plugin.id || plugin.name %>">
                            <button type="submit" class="btn">
                                <span class="icon-download">&#128229;</span> Install
                            </button>
                        </form>
                    <% } %>
                </div>
            <% }) %>
        <% } else { %>
            <div style="color:#d8dee9;font-size:1.1em;">No plugins found.</div>
        <% } %>
    </div>
</div>

<!-- Modrinth Selector Modal -->
<div id="modrinthModal" style="display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(20,24,31,0.86);z-index:10000;align-items:center;justify-content:center;">
    <div style="background:#3b4252;padding:32px 18px;border-radius:12px;max-width:96vw;max-height:90vh;overflow:auto;">
        <h3 style="color:#a3be8c;margin-bottom:12px;">Search Modrinth</h3>
        <input type="text" id="modrinthSearch" placeholder="Search on Modrinth..." style="width:84%;background:#434c5e;color:#eceff4;padding:8px 12px;border-radius:5px;border:none;">
        <button type="button" class="modrinth-btn" onclick="searchModrinth()">Search</button>
        <button type="button" class="btn" style="margin-left:10px;" onclick="closeModrinthSelector()">Close</button>
        <div id="modrinthResults" style="margin-top:18px;max-height:60vh;overflow-y:auto;"></div>
    </div>
</div>
<script>
function openModrinthSelector() {
    document.getElementById('modrinthModal').style.display = 'flex';
}
function closeModrinthSelector() {
    document.getElementById('modrinthModal').style.display = 'none';
}
// Fetch from Modrinth API and show results
async function searchModrinth() {
    const q = document.getElementById('modrinthSearch').value;
    const resultsDiv = document.getElementById('modrinthResults');
    resultsDiv.innerHTML = "Loading...";
    if(!q) return;
    try {
        const resp = await fetch(`https://api.modrinth.com/v2/search?query=${encodeURIComponent(q)}&limit=20`);
        const data = await resp.json();
        if(!data.hits || data.hits.length === 0) {
            resultsDiv.innerHTML = "<div style='color:#e57373;'>No results found.</div>";
            return;
        }
        let html = "";
        data.hits.forEach(mod => {
            html += `<div style="background:#434c5e;color:#eceff4;margin-bottom:10px;padding:12px 9px;border-radius:7px;">
                <b>${mod.title}</b> <span style="font-size:0.95em;color:#a3be8c;">by ${mod.author}</span><br>
                <span style="font-size:0.97em;">${mod.description || 'No description.'}</span><br>
                <a href="https://modrinth.com/plugin/${mod.project_id}" target="_blank" style="color:#81a1c1;text-decoration:underline;">View on Modrinth</a>
                <button class="btn" style="margin-left:12px;" onclick="selectModrinth('${mod.project_id}','${mod.title.replace(/'/g,"&#39;")}')">Select</button>
            </div>`;
        });
        resultsDiv.innerHTML = html;
    } catch (err) {
        resultsDiv.innerHTML = "<div style='color:#e57373;'>Error loading Modrinth data.</div>";
    }
}

// When user selects a Modrinth plugin, fetch versions and present install form
async function selectModrinth(projectId, displayName) {
    const resultsDiv = document.getElementById('modrinthResults');
    resultsDiv.innerHTML = "Loading versions...";
    try {
        const resp = await fetch(`https://api.modrinth.com/v2/project/${projectId}/version?loaders=["paper","fabric","forge","quilt","neoforge"]`);
        const data = await resp.json();
        if(!Array.isArray(data) || data.length === 0) {
            resultsDiv.innerHTML = "<div style='color:#e57373;'>No versions found.</div>";
            return;
        }
        let html = `<div style="background:#434c5e;padding:16px;border-radius:8px;">
            <h4 style="color:#a3be8c">${displayName}</h4>
            <form method="post" action="/instance/<%= instance ? instance.Id : 'INSTANCE_ID' %>/plugins/install" style="margin:0;">
                <input type="hidden" name="modrinth_id" value="${projectId}">
                <label for="modrinth-version-select" style="font-size:0.97em;margin-bottom:3px;">Select Version:</label>
                <select id="modrinth-version-select" name="modrinth_version" class="version-select">`;
        data.forEach(ver => {
            html += `<option value="${ver.id}">${ver.name} (${ver.version_number})</option>`;
        });
        html += `</select>
                <button type="submit" class="btn" style="margin-top:10px;">
                    <span class="icon-download">&#128229;</span> Install from Modrinth
                </button>
            </form>
            <button class="btn" style="margin-top:10px;" onclick="searchModrinth()">Back</button>
        </div>`;
        resultsDiv.innerHTML = html;
    } catch (err) {
        resultsDiv.innerHTML = "<div style='color:#e57373;'>Error loading Modrinth versions.</div>";
    }
}
</script>
